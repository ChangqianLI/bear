<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nainai's bear</title>
    <style>
        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #000;
            display: flex; flex-direction: column; align-items: center;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        #ui { 
            padding: 20px; font-size: 55px; font-weight: bold; 
            color: #ffffff; 
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            z-index: 100; transition: opacity 2s;
        }
        /* æ¸¸æˆå®¹å™¨ */
        #gameWrapper { 
            position: relative; width: 800px; height: 600px; 
            border-radius: 15px; overflow: hidden; transition: opacity 2s;
            background: #fff;
            z-index: 50; /* ç¡®ä¿æ¸¸æˆå±‚çº§ */
        }
        #gameBackground {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('back.jpg'); background-size: cover;
            background-position: center; filter: blur(5px) brightness(0.7); z-index: 1;
        }
        canvas { position: relative; display: block; z-index: 2; background: transparent; }
        #bearSprite { position: absolute; width: 120px; height: 120px; pointer-events: none; z-index: 10; }

        /* è§†é¢‘å®¹å™¨ - ä¿®æ”¹äº†ä½ç½®å’Œå±‚çº§ */
        #videoContainer {
            position: fixed; /* æ”¹ä¸º fixed è¦†ç›–å…¨å± */
            top: 0; left: 0; width: 100%; height: 100%;
            display: none; opacity: 0; transition: opacity 2s;
            z-index: 2000; /* ç¡®ä¿è§†é¢‘åœ¨æœ€ä¸Šå±‚ */
            background: black;
        }
        #endVideo { width: 100%; height: 100%; object-fit: contain; }

        #startOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        #startBtn {
            padding: 20px 40px; font-size: 28px; font-weight: bold;
            color: white; 
            background-color: #007bff; 
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
            transition: transform 0.2s, background-color 0.2s;
        }
        #startBtn:hover { transform: scale(1.1); background-color: #0056b3; }
    </style>
</head>
<body>

<div id="ui"><span id="score">0</span></div>

<div id="gameWrapper">
    <div id="startOverlay">
        <button id="startBtn">ç‚¹å‡»è¿›å…¥å¥ˆå¥ˆç‹å›½</button>
    </div>

    <div id="gameBackground"></div>
    <canvas id="gameCanvas"></canvas>
    <img id="bearSprite" src="music.gif">
</div>

<div id="videoContainer">
    <video id="endVideo" playsinline>
        <source src="video.mp4" type="video/mp4">
    </video>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const bearImg = document.getElementById('bearSprite');
    const startOverlay = document.getElementById('startOverlay');
    const startBtn = document.getElementById('startBtn');
    const gameWrapper = document.getElementById('gameWrapper');
    const videoContainer = document.getElementById('videoContainer');
    const endVideo = document.getElementById('endVideo');
    const uiDiv = document.getElementById('ui');

    canvas.width = 800; canvas.height = 600;

    let score = 0;
    let isVictory = false;
    let isTransitioning = false; // æ–°å¢ï¼šé˜²æ­¢åŠ¨ç”»é‡å¤è§¦å‘
    let gameStarted = false;
    let spriteTimer = null;
    let fallItems = [];

    const bgm = new Audio('first music.MP3');
    bgm.loop = true;

    const config = { gravity: 0.8, jumpPower: -18, moveSpeed: 10 };
    const bear = { x: 340, y: 480, width: 120, height: 120, vx: 0, vy: 0, isJumping: false };

    const itemPool = [
        { char: 'ğŸ™', sprite: 'yes.gif' }, { char: 'ğŸ£', sprite: 'yes.gif' },
        { char: 'ğŸ“¦', sprite: 'jump.gif' }, { char: 'ğŸ', sprite: 'jump.gif' },
        { char: 'ğŸ””', sprite: 'two.gif' }, { char: 'ğŸ’', sprite: 'two.gif' }
    ];

    const keys = { left: false, right: false, up: false };

    startBtn.addEventListener('click', () => {
        gameStarted = true;
        startOverlay.style.display = 'none';
        bgm.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e));
        endVideo.load(); 
        draw();
    });

    window.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft') keys.left = true;
        if (e.key === 'ArrowRight') keys.right = true;
        if (e.key === 'ArrowUp' || e.key === ' ') keys.up = true;
    });
    window.addEventListener('keyup', e => {
        if (e.key === 'ArrowLeft') keys.left = false;
        if (e.key === 'ArrowRight') keys.right = false;
        if (e.key === 'ArrowUp' || e.key === ' ') keys.up = false;
    });

    function changeBearSprite(newSrc) {
        if (isVictory) return;
        if (spriteTimer) clearTimeout(spriteTimer);
        bearImg.src = newSrc;
        spriteTimer = setTimeout(() => { 
            if (!isVictory) bearImg.src = 'music.gif'; 
            spriteTimer = null;
        }, 2000);
    }

    function triggerFinalSequence() {
        // ç¬¬ä¸€é˜¶æ®µï¼šæ·¡å‡ºæ¸¸æˆç•Œé¢
        setTimeout(() => {
            gameWrapper.style.opacity = '0'; // ä¿®æ­£ï¼šç›´æ¥è®¾ä¸º0å®Œå…¨é€æ˜
            uiDiv.style.opacity = '0';
        }, 8000);

        // ç¬¬äºŒé˜¶æ®µï¼šéšè—æ¸¸æˆç•Œé¢ï¼Œæ˜¾ç¤ºå¹¶æ’­æ”¾è§†é¢‘
        setTimeout(() => {
            bgm.pause();
            gameWrapper.style.display = 'none'; 
            uiDiv.style.display = 'none';
            videoContainer.style.display = 'block';
            
            // å¼ºåˆ¶é‡ç»˜ä»¥ç¡®ä¿display:blockç”Ÿæ•ˆåå†è¿‡æ¸¡opacity
            setTimeout(() => {
                videoContainer.style.opacity = '1';
                endVideo.play().catch(err => {
                    console.log("è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªï¼Œå°è¯•é™éŸ³æ’­æ”¾");
                    endVideo.muted = true;
                    endVideo.play();
                });
            }, 100);
            
        }, 10000);
    }

    function update() {
        if (isVictory && isTransitioning) return; // èƒœåˆ©ååœæ­¢æ›´æ–°é€»è¾‘

        // ç§»åŠ¨
        if (keys.left) { bear.vx = -config.moveSpeed; bearImg.style.transform = 'scaleX(-1)'; }
        else if (keys.right) { bear.vx = config.moveSpeed; bearImg.style.transform = 'scaleX(1)'; }
        else { bear.vx = 0; }

        bear.x += bear.vx;
        if (keys.up && !bear.isJumping) { bear.vy = config.jumpPower; bear.isJumping = true; }
        bear.vy += config.gravity; bear.y += bear.vy;

        // è¾¹ç•Œå¤„ç†
        if (bear.y > canvas.height - bear.height) { bear.y = canvas.height - bear.height; bear.vy = 0; bear.isJumping = false; }
        if (bear.x < 0) bear.x = 0;
        if (bear.x > canvas.width - bear.width) bear.x = canvas.width - bear.width;

        bearImg.style.left = bear.x + 'px';
        bearImg.style.top = bear.y + 'px';

        // ç‰©å“æ‰è½é€»è¾‘
        for (let i = fallItems.length - 1; i >= 0; i--) {
            let item = fallItems[i];
            item.y += item.speed;

            // ç¢°æ’æ£€æµ‹
            if (item.y + 40 > bear.y && item.x > bear.x - 20 && item.x < bear.x + bear.width) {
                if (!isVictory) {
                    score += 27;
                    let displayScore = Math.min(score, 523);
                    scoreElement.innerText = displayScore;

                    if (displayScore >= 523) {
                        isVictory = true;
                        
                        // ä¿®å¤ï¼šç¡®ä¿åªè§¦å‘ä¸€æ¬¡è½¬åœºé€»è¾‘
                        if (!isTransitioning) {
                            isTransitioning = true;
                            if (spriteTimer) clearTimeout(spriteTimer);
                            bearImg.src = 'celebrate.gif';
                            triggerFinalSequence();
                        }
                    } else {
                        changeBearSprite(item.targetSprite);
                    }
                }
                fallItems.splice(i, 1);
                continue;
            }

            if (item.y > canvas.height) {
                fallItems.splice(i, 1);
            }
        }

        if (!isVictory && Math.random() < 0.015) {
            const proto = itemPool[Math.floor(Math.random() * itemPool.length)];
            fallItems.push({ 
                x: Math.random() * (canvas.width - 40), 
                y: -50, 
                char: proto.char, 
                targetSprite: proto.sprite, 
                speed: 3 + Math.random() * 2 
            });
        }
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // å¦‚æœæ­£åœ¨è½¬åœºä½†è¿˜æ²¡æœ‰å®Œå…¨åˆ‡æ¢è§†é¢‘ï¼Œä¿æŒæœ€åä¸€å¸§çš„ç»˜åˆ¶æˆ–æ¸…ç©º
        if (!isTransitioning || (isTransitioning && gameWrapper.style.display !== 'none')) {
            ctx.shadowColor = "white"; ctx.shadowBlur = 7; ctx.fillStyle = "black"; ctx.font = '40px Arial';
            fallItems.forEach(item => { ctx.fillText(item.char, item.x, item.y); });
            ctx.shadowBlur = 0;
            update();
        }
        
        requestAnimationFrame(draw);
    }
</script>
</body>
</html>